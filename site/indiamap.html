import folium
import pandas
import json
import requests
from math import sin, cos, sqrt, atan2, radians



send_url = "http://api.ipstack.com/check?access_key=dc7ed55f570d3e0d2fbdbec6b7c28b23"
geo_req = requests.get(send_url)
geo_json = json.loads(geo_req.text)
latitude = geo_json['latitude']
longitude = geo_json['longitude']
city = geo_json['city']


stae = pandas.read_csv("states.txt")

lat = list(stae["LAT"])
lon = list(stae["LON"])
co = list(stae["col"])

R = 6373.0
mins = 999
for i,j in zip(lat,lon):
	dlat = radians(abs(latitude - i))
	dlon = radians(abs(longitude - j))
	a = abs(sin(dlat / 2)**2 + cos(i) * cos(latitude) * sin(dlon / 2)**2)
	c = 2 * atan2(sqrt(a), sqrt(1 - a))
	distance = R * c
	if distance < mins:
		mins = distance
		i1= i
		j1 = j



map = folium.Map(location=[20.5937, 78.9629],zoom_start=5,titles="Stamen Terrain")
fgr = folium.FeatureGroup(name="Red zone")
fgg = folium.FeatureGroup(name="green zone")
fgo = folium.FeatureGroup(name="Orange zone")
map.add_child(folium.Marker(location=[latitude,longitude],popup='Current location\n'+"Nearest zone is "+str(mins)+" km away",icon=folium.Icon(color='black')))
map.add_child(folium.PolyLine(locations = [[latitude,longitude],[i1,j1]],color = 'red',weight=2.5,opacity=1))

for lt,ln,colo in zip(lat,lon,co):
	if colo == 'red':
		fgr.add_child(folium.CircleMarker(location=[lt,ln],radius=10,popup=str(colo)+' zone',fill_color = str(colo), color = 'gray',fill_opacity= 0.7))
	elif colo == 'orange':
		fgo.add_child(folium.CircleMarker(location=[lt,ln],radius=10,popup=str(colo)+' zone',fill_color = str(colo), color = 'gray',fill_opacity= 0.7))	
	else:
		fgg.add_child(folium.CircleMarker(location=[lt,ln],radius=10,popup=str(colo)+' zone',fill_color = str(colo), color = 'gray',fill_opacity= 0.7))
map.add_child(fgr)
map.add_child(fgg)
map.add_child(fgo)
map.add_child(folium.LayerControl())
map.save("indiamap.html")